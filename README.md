# ToolKit Vision MVP

Прототип веб‑приложения для ускорения учета авиационных инструментов на этапах выдачи и возврата. Решение включает минималистичный FastAPI бэкенд, который хранит сессии сверки, принимает изображения и обращается к предобученному детектору **YOLOv11** (Ultralytics), а также одностраничный фронтенд без внешних зависимостей.

## Ключевые возможности
- Создание сессии пересчета в режимах выдачи (`handout`) и возврата (`handover`).
- Настройка порога совпадений и перечня ожидаемых инструментов (каталог из ТЗ).
- Загрузка фотографии рабочего стола и получение расшифровки: список найденных инструментов, процент совпадения, отсутствующие и посторонние предметы.
- Локальный детектор на YOLOv11 (Ultralytics) с готовой разметкой из `ml/dataset.yaml`; при желании можно переключить систему на внешний CV‑сервис через REST.
- Современный UI/UX на чистом HTML/CSS/JS с drag‑and‑drop загрузкой, без сборщиков и сторонних библиотек.
- Мультишаговый мастер («Настройка → Загрузка → Результаты») с адаптивной вёрсткой, удобной на мобильных устройствах.
- Управление учётными записями инженеров и ролями (`admin`, `engineer`) прямо из админ-панели.
- Персистентное хранение сессий и результатов анализа в базе SQLite, доступной для последующего аудита.
- Отдельная админ-панель `/admin` с авторизацией инженеров и списком всех сессий.

## Стек и структура
```
requirements.txt     # Python-зависимости (FastAPI, Uvicorn, httpx)
backend/
  __init__.py
  app/
    main.py          # Создание FastAPI-приложения и подключение фронтенда
    core/
      config.py      # Конфигурация и работа с переменными окружения
      tool_catalog.py# Справочник инструментов из ТЗ
    api/
      routes.py      # REST-эндпоинты /api/*
    db/
      base.py        # Базовый класс SQLAlchemy
      models.py      # ORM-таблицы для сессий, анализов и инженеров
      session.py     # Создание engine и фабрики сессий
    services/
      detection_client.py # Локальный YOLOv11 детектор + HTTP fallback
      session_service.py  # Управление сессиями, анализ результатов
      auth_service.py     # Аутентификация инженеров и токены доступа
    models/
      session.py      # Датаклассы доменной модели
    schemas.py        # Pydantic-схемы запросов/ответов
frontend/
  index.html          # SPA-интерфейс
  styles.css
  app.js              # Логика мастера: настройка сессии, загрузка и показ результатов
  admin.html          # Кабинет администратора / инженера
  admin.js            # Авторизация и отображение списка сессий
```

Загрузки изображений сохраняются в каталоге `data/uploads/` (создается автоматически).
Весы детектора и описание классов лежат в `ml/best.pt` и `ml/dataset.yaml` соответственно.

## Быстрый старт
1. **Создайте окружение и установите зависимости** (включает `torch` и `ultralytics`, убедитесь, что у Python есть доступ к нужным колёсам)
   ```bash
   python3 -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   ```
2. **Запустите бэкенд** (из корня репозитория, чтобы фронтенд корректно отдавался)
   ```bash
   uvicorn backend.app.main:app --reload --port 8000
   ```
3. **Откройте интерфейс**: [http://localhost:8000](http://localhost:8000)
4. Для проверки детектора отправьте изображение на `POST /api/vision/detect` или создайте сессию на главной странице.

API доступно по адресу `http://localhost:8000/api`. Автоматическая документация: `http://localhost:8000/docs` (Swagger UI) и `http://localhost:8000/redoc`.

## Запуск через Docker Compose
1. Убедитесь, что Docker и docker-compose установлены.
2. Перед первым запуском задайте безопасный пароль администратора в файле `docker-compose.yml` или через переменные окружения.
3. Соберите и стартуйте контейнеры:
   ```bash
   docker-compose up --build
   ```
4. Статические файлы и база данных монтируются из директории `./data`, поэтому сессии и загруженные изображения сохраняются между перезапусками.

## Конфигурация
Параметры можно задавать через переменные окружения:

| Переменная | Назначение | Значение по умолчанию |
|------------|------------|-----------------------|
| `DETECTION_SERVICE_URL` | Базовый URL внешнего сервиса детекции (если не задан – используется заглушка). | `None` |
| `DETECTION_TIMEOUT_SECONDS` | Таймаут ожидания ответа детектора. | `8.0` |
| `UPLOAD_DIR` | Путь к каталогу для сохранения загруженных изображений. | `data/uploads` |
| `ALLOWED_ORIGINS` | Разрешённые CORS-источники, через запятую. | `*` |
| `DATABASE_URL` | Строка подключения SQLAlchemy (по умолчанию файловая SQLite). | `sqlite:///data/app.db` |
| `INITIAL_ADMIN_USERNAME` | Имя пользователя для автоматического создания администратора. | `admin` |
| `INITIAL_ADMIN_PASSWORD` | Пароль администратора, создаётся при старте сервера. | `admin123` |

## Авторизация и админ-панель
- Интерфейс `/admin` позволяет инженерам и администраторам просматривать историю всех сессий сверки. После входа отображается таблица с ключевыми показателями и статусами.
- При первом старте сервиса автоматически создаётся учётная запись администратора с данными из `INITIAL_ADMIN_USERNAME` и `INITIAL_ADMIN_PASSWORD`. Перед выкладкой в продуктив обязательно переопределите пароль через переменные окружения.
- Каждая успешная авторизация выдаёт одноразовый токен (Bearer). Повторный логин переоткрывает сессию, а запрос `POST /api/auth/logout` отзывает токен.
- Администратор может управлять командами: раздел «Учетные записи» в админ‑панели позволяет создавать пользователей с ролью `engineer` или `admin`.
- Все токены и сотрудники хранятся в той же базе данных SQLite; при переходе на PostgreSQL схема совместима.

## REST API (основные эндпоинты)
- `GET /api/health` — проверка состояния сервиса.
- `GET /api/tools` — каталог поддерживаемых инструментов.
- `POST /api/auth/login` — вход инженера, в ответе Bearer-токен.
- `POST /api/auth/logout` — отзыв текущего токена.
- `GET /api/auth/me` — профиль текущего пользователя.
- `GET /api/admin/sessions` — список всех сессий (только для админов).
- `GET /api/admin/engineers` — перечень инженеров и их ролей (только для админов).
- `POST /api/admin/engineers` — создание нового пользователя (только для админов):
  ```json
  {
    "username": "qa_lead",
    "password": "s3cret!",
    "role": "engineer"
  }
  ```
- `POST /api/sessions` — создание сессии. Тело запроса:
  ```json
  {
    "mode": "handout",
    "expected_tool_ids": ["flat_screwdriver", "phillips_screwdriver"],
    "threshold": 0.9
  }
  ```
- `POST /api/sessions/{session_id}/analyse` — загрузка изображения (`multipart/form-data`, поле `file`). Возвращает процент совпадения, найденные, отсутствующие и неожиданные элементы.
- `GET /api/sessions/{session_id}` — сведения о сессии и все прошлые анализы.
- `POST /api/vision/detect` — одиночный запуск детекции без создания сессии (возвращает список найденных инструментов).
- `GET /api/vision/status` — проверка конфигурации детектора (название backend, список классов, параметры).

## Подключение реального детектора
Модуль `backend/app/services/detection_client.py` содержит три клиента:
1. `YoloDetectionClient` — основной вариант. Загружает `ml/best.pt`, использует классы из `ml/dataset.yaml` и возвращает `tool_id`/`label` по каталогу.
2. `MockDetectionClient` — детерминированная заглушка, на которую система откатывается при ошибке загрузки модели.
3. `HttpDetectionClient` — клиент для внешнего FastAPI сервиса. Ожидает конечную точку `POST /detect`, принимающую файл `file` и возвращающую JSON вида:
   ```json
   {
     "detections": [
       {"tool_id": "flat_screwdriver", "label": "Отвертка плоская", "confidence": 0.94},
       {"tool_id": null, "label": "Unknown object", "confidence": 0.52}
     ]
   }
   ```
По умолчанию используется локальный YOLOv11-детектор. Чтобы принудительно переключиться на внешний сервис, задайте `DETECTION_SERVICE_URL=http://host:port` перед запуском сервера.

### Настройки детектора

Ключевые переменные окружения (значения по умолчанию указаны в `backend/app/core/config.py`):

| Переменная | Назначение |
| --- | --- |
| `YOLO_MODEL_PATH` | Путь до весов (`ml/best.pt`). |
| `YOLO_DATASET_CONFIG` | YAML с классами (`ml/dataset.yaml`). |
| `YOLO_CONFIDENCE_THRESHOLD` | Минимальный `conf` (0.0–1.0, по умолчанию 0.25). |
| `YOLO_IMAGE_SIZE` | Размер входа (`imgsz`, по умолчанию 720). |
| `YOLO_DEVICE` | Устройство инференса (`cpu`, `cuda:0`, и т. п.). |
| `DETECTION_SERVICE_URL` | Если указан, вместо локального YOLO вызывается внешний HTTP сервис. |

При невозможности загрузить модель (например, отсутствуют файлы или нет поддержки CUDA/CPU) система автоматически откатится к детерминированной заглушке.

Дополнительные подробности — в `docs/detector.md`.

## Пользовательский сценарий
1. На шаге «Настройка» выбрать режим, порог совпадений и перечень ожидаемых инструментов.
2. Перейти на шаг «Загрузка» и отправить фотографию рабочего стола (drag‑and‑drop или выбор файла).
3. На шаге «Результаты» изучить процент совпадения, найденные, отсутствующие и посторонние инструменты.
4. При необходимости вернуться к предыдущим шагам, загрузить другой снимок или создать новую сессию.
5. Администратор может открыть `/admin`, авторизоваться и просмотреть историю сессий или управлять учётными записями инженеров.

## Дальнейшее развитие
- Подключение настоящей модели компьютерного зрения и выдача координат bounding box.
- Переход на PostgreSQL + Alembic для миграций, добавление расширенной ролевой модели (ИТП, QA, кладовщик).
- Интеграция с корпоративными системами ТОиР и выгрузка отчётов в JSON/PDF.
- Экспорт аналитики в BI-инструменты и построение дашбордов с метриками по цехам.
- Дополнительные настройки качества (например, минимальный confidence, фильтры по типам инструмента).

